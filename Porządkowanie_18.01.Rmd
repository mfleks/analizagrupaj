---
title: "ANALIZA DANYCH-PROJEKT"
author: "Maciej Fleks, Małgorzata Dudanowicz, Krzysztof Kowalski"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
#biblioteki
library(dplyr) 
library(ggplot2)
library(summarytools)
library(validate)
library(validatetools)
library(dcmodify)
library(errorlocate)
library(deductive)
library(simputation)
library(lumberjack)
library(ISLR)
library(xts)
library(quantmod)
library(ROCR)
library(DMwR)
library(Information)
library(scorecard)
library(editrules)
library(VIM)
library(deducorrect)
library(ISLR) 
library(janitor)
library(naniar)
library(mice)
library(editrules)
library(DMwR2)
library(outliers)
library(moments)
library(classInt)
library(corrplot)
library(ggpubr)
library(ggstatsplot)
library(rstantools)
```

```{r}
#Na poczatku wczytujemy zbior danych
rowery<-read_excel("sklep_rowerowy.xlsx")
rowery 
```

# **SKLEP ROWEROWY**

Analizowany zbiór danych zawiera informacje na temat klientów sklepu rowerowego. Z jego pomocą możemy uzyskać informacje na temat wieku, dochodu, płci, liczby posiadanych dzieci czy regionu pochodzenia klientów sklepu. Celem projektu jest przeprowadzenie kompleksowej analizy danych, która obejmować będzie kilka kluczowych etapów, a mianowicie: czyszczenie danych, wizualizację, analizę opisową i wnioskowanie statystyczne.

## I ETAP - CZYSZCZENIE DANYCH

### 1. Przegląd danych

Obserwujemy m.in. spacje w nazwach kolumn naszych zmiennych. Aby się ich pozbyć korzystamy z funkcji clean_names z pakietu 'janitor', która służy do przekształcania nazw kolumn w ramce danych w formę bardziej czytelną i zgodą z konwencją.

```{r}
head(rowery) 
rowery <- clean_names(rowery) 
```

#### 1. Sprawdzenie występowania brakujących obserwacji NA

Poniżej przeprowadzona została analiza wartości brakujących NA dla poszczególnych zmiennych. Wskazano zarówno liczbę wierszy, w których występują braki, jak i konkretne ich numery. W ten sposób dowiadujemy się przykładowo, że zmienna "home_owner" ma 4 braki i występują one w wierszach: 7, 366, 647 i 944. Przedstawiono również wizualizację wartości brakujących.

```{r}
sum(complete.cases(rowery)) #952 pełnych wierszy, czyli mamy 48 wierszy, w ktorych sa braki
manyNAs(rowery) #689 wiersz zawiera najwiecej brakow
sum(is.na(rowery)) #w sumie wystepuja 53 braki
miss_var_summary(rowery) #widzimy, że braki wystepuja jedynie dla zmiennych gender (11), cars(9),children (8), age(8), marital_status(7), income(6) i home_owner(4). Pozostale zmienne nie posiadaja zadnych wartosci brakujacych
rowery %>% 
  miss_case_table() #mamy 44 wiersze, w ktorych brak jest jednej wartosci, 3 wiersze z 2 brakami i jeden wiersz z 3 wartosciami NA
md.pattern(rowery) #wykres do zilustrowania brakow kazdej zmiennej
which(is.na(rowery$gender)) #4, 155, 336, 602, 689, 696, 868, 909, 952, 974, 998- numery wierszy, w ktorych sa braki dla zmiennej gender
which(is.na(rowery$cars)) #13, 197, 203, 352, 449, 512, 562, 616, 934-numery wierszy, w ktorych sa braki dla zmiennej cars
which(is.na(rowery$children)) #118, 218, 387, 550, 639, 689, 806, 961- numery wierszy, w ktorych sa braki dla zmiennej children
which(is.na(rowery$age)) #10,  99, 226, 372, 555, 689, 771, 987-numery wierszy, w ktorych sa braki dla zmiennej age
which(is.na(rowery$marital_status)) #9,  28,  50,  99, 151, 235, 302-numery wierszy, w ktorych sa braki dla zmiennej marital_status
which(is.na(rowery$income)) #10, 111, 192, 302, 442, 510-numery wierszy, w ktorych sa braki dla zmiennej income
which(is.na(rowery$home_owner)) #7, 366, 647, 944-numery wierszy, w ktorych sa braki dla zmiennej home_owner
```

#### 2. Sprawdzenie typów danych w każdej kolumnie

Sprawdzanie typów danych w każdej kolumnie jest kluczowe dla zachowania poprawności, efektywności oraz precyzji analizy danych.

```{r}
data_class <- data.frame(class = sapply(rowery, class))
data_class
```

#### 3. Sprawdzenie wiarygodności danych

Poprzez wywołanie podstawowych statystyk możemy sprawdzić, czy nasze dane wydają się być wiarygodne, tzn. czy średnia ilość posiadanych dzieci, czy samochodów wydaje się być prawdopodobna. Ponadto użycie 'view(dfSummary(dane))' dostarcza nam wielu cennych informacji m.in.:

-   widzimy, że każdy klient posiada unikalne id,
-   otrzymujemy podsumowanie braków obserwacji dla każdej zmiennej,
-   dla zmiennych jakościowych widzimy możliwe kategorie wyboru wraz z informacją o częstości jej wystąpienia.

```{r}
summary(rowery)
view(dfSummary(rowery))
descr(rowery)
```

#### 4. Sprawdzanie spełnienia pewnych reguł dla zbioru danych

Posiadając już podstawową wiedzę na temat naszych danych, chcemy sprawdzić kilka podstawowych reguł: czy zmienna wiek na pewno wszędzie przyjmuje wartości dodatnie, czy liczba posidanych dzieci nie jest nigdzie ujemna, czy liczba posiadanych samochodów nie jest ujemna, czy płeć przyjmuje jedną z dwóch kategorii 'kobieta' i 'mężczyna'.

```{r}
rules <- validator(age > 0, gender %in% c('Female','Male')
                  , income >= 0, children >= 0, cars >= 0)
cf <- confront(rowery, rules, key="id")
summary(cf)
barplot(cf, main="rowery") #wizualizacja spełnienia reguły
#as.data.frame(cf) %>% head()

#Inny sposob
RULE <- editset(c("age > 0","gender %in% c('Female','Male')"
                  , "income >= 0", "children >= 0", "cars >= 0"))
RULE

summary(violatedEdits(RULE, rowery))
#rowery[localizeErrors(RULE, rowery)$adapt] <- NA -> w razie niespelnienia ktores z regul wartosci zmieniamy na NA
```

Okazuje się, że wszystkie reguły w naszym zbiorze danych są spełnione.

### 2. Imputacja danych

Z analiz przeprowadzonych powyżej wynika, że w naszym zbiorze danych zlokalizowano 53 braki danych. Podjęto decyzję o nieusuwaniu żadnego z wierszy i uzupełnieniu wartości NA za pomocą różnych metod.

#### 1. Imputacja-zmienne ilościowe

Braki w zmiennych dotyczących dochodu, wieku, liczby posidanych dzieci i samochodów wypełnione zostaną za pomocą średniej. Ze względu na specyfikę danych age, children i cars, wartości te nie powinny mieć żadnych miejsc po przecinku, gdyż nie możemy posiadać np. 1.5 dziecka.

```{r}
rowery %>% filter(is.na(income)) %>% head
rowery[is.na(rowery$income), "income"] <- mean(rowery$income, na.rm = T)

# Inny sposob
#dochod<-imputate_na(rowery, income, method = "mean")
#summary(dochod)
#plot(dochod)

rowery %>% filter(is.na(age)) %>% head
rowery[is.na(rowery$age), "age"] <- round(mean(rowery$age, na.rm = T), digits=0)

rowery %>% filter(is.na(cars)) %>% head
rowery[is.na(rowery$cars), "cars"] <- round(mean(rowery$cars, na.rm = T), digits=0)

rowery %>% filter(is.na(children)) %>% head
rowery[is.na(rowery$children), "children"] <- round(mean(rowery$children, na.rm = T), digits=0)
```

#### 2. Imputacja-zmienne jakościowe

Po uzupełnieniu braków w zmiennych ilościowych, przystępujemy teraz do korekty brakujących danych w przypadku zmiennych jakościowych. Ponieważ nasze zmienne jakościowe zawierają jedynie dwie kategorie, planujemy zidentyfikować, która z tych kategorii jest dominująca. Następnie, braki danych w tych zmiennych zostaną wypełnione wartościami dominującymi, aby zachować spójność i ułatwić analizę danych.

```{r}
unique(rowery$home_owner) # dwie kategorie- tak i nie
unique(rowery$marital_status) # dwie kategorie- zamezny i singiel
unique(rowery$gender) # dwie kategorie- kobieta i mezczyzna

mice_plot <-aggr(rowery, col=c('navyblue', 'yellow'),numbers=TRUE, sortVars=TRUE, labels=names(rowery), cex.axis=7, ylab=c("Histogram of missing data","Pattern")) #wykres obrazujacy braki danych

#uzupelnianie danych dominanta
rowery[is.na(rowery$home_owner), "home_owner"] <- "Yes" #68,5% klientow posiada dom, jest to wiekszosc, wiec braki w danych uzupelniamy wartosci 'Yes'
rowery[is.na(rowery$marital_status), "marital_status"] <- "Married" #53,9% klientow posiada meza/zone, wiec braki w danych uzupelniamy wartoscia 'Married'
rowery[is.na(rowery$gender), "gender"] <- "Male" #50,6% klientow to mezczyzni, wiec braki w danych uzupelniamy wartoscia 'Male'

view(dfSummary(rowery)) #Wywolujemy tabelke podsumowujaca nasze dane. Widzimy, ze wszystkie dane zostaly uzupelnione.
```

### 3. Obserwacje odstające

Sprawdzanie zbioru danych pod kątem wartości odstających jest kluczowe dla utrzymania jakości analizy danych i poprawnego zrozumienia badanego zjawiska. W przypadku identyfikacji wartości odstających, istnieją różne metody ich obsługi, takie jak usuwanie, transformacja, czy stosowanie bardziej zaawansowanych technik modelowania. Przechodzimy więc do sprawdzenia naszego zbioru danych pod względem występowania wartości odstających.

#### 1. Zlokalizowanie wartości odstających

Możemy przykładowo stworzyć funkcję, która będzie wykrywać obserwacje odstające.

```{r}
find_outliers <- function(rowery, k = 1.5) {
quantiles <- quantile(rowery, c(0.25, 0.5, 0.75))
diff <- k * (quantiles[3] - quantiles[1])
lb <- quantiles[1] - diff 
ub <- quantiles[3] + diff
  
is_outlier <- function(el) {
    el < lb || ub < el  
  }}
```

Z pomocą funkcji 'boxplot.stats' możemy wyświetlić, które wartości są odstające. Widzimy, że mamy aż 10 wartości odstających dla zmiennej 'income'.

```{r}
out <-boxplot.stats(rowery$income)$out 
out
```

Możemy również skorzystać z testów statystycznych.

```{r}
test <- grubbs.test(rowery$income)
test #test Grubba'a potwierdza, ze najwyzsza wartosc 170 000 jest odstajaca
test1 <- grubbs.test(rowery$income, opposite = TRUE)
test1 #najmniejsza wartosc nie jest odstajaca
```

Zwizualizujmy teraz wartości odstające na wykresie wraz z opisem, które z nich są odstające.

```{r}
boxplot(rowery$income, col = "blue",
  ylab = "income",
  main = "Boxplot of income")
mtext(paste("Outliers: ", paste(out, collapse = ", ")))
```

Sprawdźmy jeszcze występowanie wartości odstających dla zmiennej 'age'.

```{r}
boxplot.stats(rowery$age)$out #mamy 4 wartosci odstajace dla age
test <- grubbs.test(rowery$age)
test #test potwierdza, ze najwyzsza wartosc 89 jest odstajaca
```

#### 2. Przekształcenie wartości odstających

Zdecydowano się przekształcić wartości odstające dla zmiennych "age" i "income" za pomocą metody capping. Metoda capping polega na ustaleniu górnej (max) i dolnej (min) granicy wartości dla danej zmiennej, a następnie przypisanie wszystkim wartościom przekraczającym te granice wartości skrajnych.

```{r}
#income
qnt <- quantile(rowery$income, probs=c(.25, .75), na.rm = T)
caps <- quantile(rowery$income, probs=c(.05, .95), na.rm = T)
H <- 1.5 * IQR(rowery$income, na.rm = T)
rowery$income[rowery$income < (qnt[1] - H)] <- caps[1]
rowery$income[rowery$income > (qnt[2] + H)] <- caps[2]
boxplot.stats(rowery$income)$out #brak wartosci odstajacych dla income

#age
qnt <- quantile(rowery$age, probs=c(.25, .75), na.rm = T)
caps <- quantile(rowery$age, probs=c(.05, .95), na.rm = T)
H <- 1.5 * IQR(rowery$age, na.rm = T)
rowery$age[rowery$age < (qnt[1] - H)] <- caps[1]
rowery$age[rowery$age > (qnt[2] + H)] <- caps[2]
boxplot.stats(rowery$age)$out #brak wartosci odstajacych dla age
```

Dzięki procesowi czyszczenia danych osiągnięto spójność w zbiorze danych. Brakujące wartości zostały uzupełnione, a błędy zostały skorygowane, co pozwali teraz na bardziej precyzyjną analizę.

## II ETAP-WIZUALIZACJE

Wizualizacje stanowią potężne narzędzie w każdym projekcie, wspomagają efektywną komunikację, lepsze zrozumienie danych oraz sprzyjają szybszemu i bardziej kreatywnemu podejmowaniu decyzji.Poniżej przedstawiono kilka ciekawych wizualizacji dla analizowanego zbioru danych.

### 1.Średni dochód w zależności od wieku i płci

Prezentowany wykres składa się z dwóch paneli, z których lewy reprezentuje dane dotyczące kobiet, natomiast prawy mężczyzn. Na obu panelach zaznaczone są czerwone punkty, odzwierciedlające empiryczne dane dotyczące średnich dochodów w poszczególnych grupach wiekowych. Linie trendu w kolorze niebieskim zostały dopasowane do punktów, ukazując ogólny trend wzrostu średnich dochodów w miarę postępującego wieku.Warto zauważyć, że panel mężczyzn charakteryzuje się większym zróżnicowaniem (różnicą) średnich dochodów, jednocześnie prezentując wyższą średnią wartość dochodu. Dodatkowo, dla mężczyzn zauważalny jest silniejszy trend wzrostu średniego dochodu wraz z wiekiem. To sugeruje, że w miarę upływu lat różnice w dochodach między różnymi grupami wiekowymi mężczyzn mogą się nasilać, tworząc bardziej zauważalne tendencje wzrostowe.

```{r}
dw1<-rowery%>%
  group_by(age, gender)%>%
  summarize(meaninc=mean(income))
ggplot(dw1, aes(age, meaninc))+
  geom_line()+
  geom_point(colour="red")+
  facet_wrap(~gender)+
  labs(x="Wiek", y="Średnie dochody")
ggplot(dw1, aes(age, meaninc))+
  geom_line()+
  geom_point(colour="red")+
  facet_wrap(~gender)+labs(x="Wiek", y="Średnie dochody")+geom_smooth(method="lm")+ggtitle("Średni dochód w zależności od wieku oraz płci")
```

### 2. Występowanie obserwacji o określonym wieku i dochodzie

Na ponizszym wykresie przedstawiony został wykres punktowy. Każdy punkt na wykresie reprezentuje jeden przypadek. Wielkość punktu z kolei odpowiada częstości występowania obserwacji o określonym wieku i poziomie dochodów.Analizując wykres można stwierdzić, że większość obserwacji skupia się w przedziale wiekowym 30-60 lat i niższym przedziale dochodowym.

```{r}
ggplot(rowery, aes(age, income))+
  stat_sum(alpha=0.4)+
  scale_size(range=c(1,5))+
  ggtitle("Występowanie obserwacji o określonym wieku oraz poziomie dochodów")+labs(x="Wiek", y="Dochód", size="Występowanie")
```

### 3. Ilość posidanych samochodów w zależności od regionu

Na poniższym wykresie pokazany jest stosunek liczby posiadanych samochodów w gospodarstwie domowym ze względu na region z którego pochodzą klienci sklepu rowerowego. Rzuca sie w oczy fakt, że w Ameryce Północnej zdecydowanie najwięcej osób posiada 2 samochody.Region ten posiada również największy odsetek gospodarstw domowych z jednym samochodem. Najwięcej klientów nieposiadających samochodu zamieszkuje Europę- około 120.Jeśli chodzi o Pacyfik to jest tam najmniejszy odsetek gospodarstw bez samochodu, ponieważ tylko około 20. Ten region charakteryzyje się też najmniejszą dysproporcją jeżeli chodzi o liczbę samochodów.

```{r}
ggplot(rowery, aes(x=cars, fill=region))+
  geom_bar(position="dodge")+
  labs(x="Ilość posiadanych samochodów", y="Występowanie", fill="Region")
```

### 4.Zagęszczenie obserwacji o określonym wieku w zależności od regionu

Poniższy wykres przedstawia rozkład wieku dla trzech różnych regionów: Europy, Ameryki Półnicnej i Pacyfiku. Oś pozioma (x) reprezentuje wiek, a oś pionowa (y) reprezentuje zagęszczenie, czyli estymowaną gęstość prawdopodobieństwa obserwacji w każdym punkcie osi wieku. W Europie największe zagęszczenie obserwacji występuje wśród osób w średnim wieku, z szczytem około 40 lat. Dla Ameryki Północnej rozkład wieku jest szerszy, z szczytem około 50 lat. Region Pacyfiku wydaje się mieć najszerszy rozkład wieku z największym zagęszczeniem wśród osób w wieku około 30 lat i stopniowym spadkiem w kierunku wyższych grup wiekowych. Rozkład wieku w Europie jest bardziej szpiczasty i mniej rozproszony niż w Ameryce Północnej, co może sugerować mniejszą różnorodność wieku w tym regionie. Linie obrysujące każdą z krzywych gęstości dają wyobrażenie o kształcie rozkładu dla każdego regionu, pozwalając dostrzec, gdzie znajdują się największe skupiska obserwacji.

```{r}
ggplot(rowery, aes(age, fill=region))+
  geom_density(alpha=0.25)+
  labs(x="Wiek",y="Zagęszczenie", fill="Region")+
  ggtitle("Zagęszczenie obserwacji o określonym poziomie wieku w zależności od regionu")
```

### 5. Obserwacje o określonym poziomie dochodów w zależności od rodzaju zawodu

Na przedstawionym wykresie można zauważyć, że dochody poszczególnych grup zawodowych są znacznie zróżnicowane. Pracownicy fizyczni najczęściej osiągają najniższe wynagrodzenia, podczas gdy pracownicy biurowi zarabiają nieco więcej. Wykwalifikowani pracownicy fizyczni cieszą się średnimi dochodami, a pracownicy profesjonalni oraz ci na stanowiskach kierowniczych osiągają najwyższe wynagrodzenia.

```{r}
ggplot(rowery, aes(income, fill=occupation))+
  geom_histogram(bins=20, color='black')+
  facet_wrap(~occupation, nrow=5)+
  labs(x="Dochód", y="Występowanie", fill="Praca")+
  theme(legend.position = 'none')+
  ggtitle("Wystepowanie obserwacji o określonym poziomie dochodów w zależności od rodzaju zawodu")
```

### 6. Wizualizacja poziomu dochodu w zależności od płci

Wykres poniżej pokazuje medianę dochodu, a także jego maksymalny, minimalny i średni poziom w zależności od płci.Mediana i średnie dochody są przedstawione na podobnym poziomie dla obu płci, z lekkim przesunięciem w kierunku wyższych wartości dla mężczyzn. Rozstęp dochodów, czyli różnica między kwartylem górnym a dolnym, również wydaje się być podobny dla obu grup.

```{r}
ggplot(rowery, aes(income, fill=occupation))+
  geom_histogram(bins=20)+
  facet_wrap(~occupation, nrow=5)+
  labs(x="Dochód", y="Występowanie", fill="Praca")+
  theme(legend.position = 'none')
ggplot(rowery, aes(gender, income))+
  geom_boxplot(aes(fill=gender))+
  stat_boxplot(geom="errorbar",position="dodge")+
  stat_summary(aes(ymin=after_stat(y),ymax=after_stat(y)),fun=mean)+ggtitle("Mediana dochodów, maksymalny, minimalny oraz średni dochód w zależności od płci")+theme(legend.position='none')
```

### 7. Ilość posiadanych samochodów w zależności od posiadania roweru

Wykres poniżej może sugerować, że osoby posidające rower mają tendencję do posiadania mniej samochodów niż osoby, które roweru nie posiadają.

```{r}
ggplot(rowery, aes(occupation, fill=occupation))+geom_bar()+facet_wrap(~education, nrow=5)+labs(x="Zatrudnienie", y="Występowanie")+theme(legend.position= 'none')
ggplot(rowery, aes(cars, fill=purchased_bike))+geom_histogram(bins=5, position="dodge", color='black')+facet_wrap(~purchased_bike)+theme(legend.position='none')+labs(x="Ilość posiadanych samochodów", y="Występowanie")+ggtitle("Ilość posiadanych samochodów w zależności od posiadania roweru")
```

### 8. Występowanie obserwacji o poszczególnym rodzaju wykonywanej pracy według wykształcenia

Poniższy rysunek przedstawia występowanie obserwacji o poszczególnym rodzaju wykonywanej pracy według wykształcenia. Najwięcej osób z wykształceniem licencjackim pracuje na stanowisku kierownicznym albo jako profesjonalista. Natomiast najmniej na stanowisku urzędniczym.Jeśli chodzi o osoby z wykształceniem wyższym to także najwięcej osób pracuje na stanowisku kierowniczym (ok. 60 obserwacji). Najmniej osób pracuje na stanowisku pracy fizycznej (ok. 10 obserwacji). Spoglądając na osoby z wykształceniem licealnym to największa ich liczba jest zatrudniona na stanowisku fachowego pracownika fizycznego, jako profesjonalista i pracownik fizyczny (odpowiednio ok. 60, 50 i 40 obserwacji). Natomiast najmniej osób z tym wykształceniem jest zatrudnionych jako menedżer lub pracownik biurowy (ok. 10 i 5 obserwacji). Analizując rodzaj wykonywanej pracy przez osoby z nieskończonymi studiami wyższymi to można zauważyć, iż największy udział pracujących to profesjonaliści (ok. 60 obserwacji), a najmniejszy dotyczy menedżerów (ok. 5 obserwacji). Analizując ostatnią kategorię wykształcenia, zaobserwowano tutaj najmniejszą liczbę obserwacji. Najwięcej osób z wykształceniem niepełnym licealnym jest zatrudnionych jako pracownik manualny (ok. 30 obsrwacji), a najmniej ponieważ 0 na stanowisku menedżera.

```{r}
ggplot(rowery, aes(marital_status, age))+
  geom_boxplot(aes(fill=marital_status))+
  stat_boxplot(geom="errorbar", position="dodge")+
  stat_summary(aes(ymin=..y..,ymax=..y..), fun=mean)
ggplot(rowery, aes(occupation, fill=occupation))+
  geom_bar(color='black')+
  facet_wrap(~education, nrow=5)+
  labs(x="Zatrudnienie", y="Występowanie")+
  theme(legend.position= 'none')+
  ggtitle("Występowanie obserwacji o poszczególnym rodzaju wykonywanej pracy według wykształcenia")
```

### 9. Średni dochód według wykształcenia oraz rodzaju pracy

Mapa cieplna jest pomocna w szybkim zrozumieniu, jak różne kombinacje wykształcenia i zawodu wpływają na dochód, gdzie ciemniejsze kolory wskazją na wyższe dochody, a jaśniejsze na niższe. Kategoria 'Management' wydaje się oferować najwyższe dochody niezależnie od poziomu wykształcenia. Z kolei prace biurowe i prace fizyczne mają tendencję do przynoszenia niższych dochodów.

```{r}
ggplot(rowery, aes(occupation, education, fill=income))+
  geom_tile(color='black')+
  scale_fill_gradient2(low="white", mid="yellow", high="red")+
  ggtitle("Średni dochód według wykształcenia oraz rodzaju pracy")+labs(x="Zawód", y="Wykształcenie", fill="Dochód")
```

### 10. Analiza wieku według stanu cywilnego

Z wykresu można zauważyć, że mediany wieku dla obu grup są różne-dla osób zamężnych/żonatych jest wyższa niż dla osób stanu wolnego. Średni wiek w obu grupach wydaje się zbliżony do mediany, ale nieznacznie wyższy u mężczyzn.

```{r}
ggplot(rowery, aes(gender, income)) +
  geom_boxplot(aes(fill=gender))+
  stat_boxplot(geom="errorbar", position="dodge")+stat_summary(aes(ymin=..y..,ymax=..y..),fun=mean)
ggplot(rowery, aes(marital_status, age))+
  geom_boxplot(aes(fill=marital_status))+
  stat_boxplot(geom="errorbar", position="dodge")+
  stat_summary(aes(ymin=..y..,ymax=..y..), fun=mean)+
  labs(x="Stan cywilny", y="Wiek")+
  theme(legend.position='none')+
  ggtitle("Mediana, maksimum, minimum oraz średnia wieku według stanu cywilnego")
```

###11. Stan cywilny oraz region

Zdecydowanie najwięcej osób zamężnych wśród klientów sklepu rowerowego występowało w Ameryce Północnej. W Europie oraz Pacyfiku występuje niemal identyczna ilość zarówno singli jak i osób po ślubie.

```{r}
ggplot(rowery, aes(marital_status, fill=marital_status))+
  geom_bar(position="dodge")+
  facet_wrap(~region)+
  theme(legend.position='none')+
  labs(x="Stan cywilny", y="Ilość")+
  ggtitle("Ilość osób o poszczególnym stanie cywilnym w zależności od regionu")
```

## III ETAP-ANALIZA OPISOWA

Analiza opisowa jest nieodzownym elementem każdego projektu. Dostarcza podstawowych informacji, które stanowią punkt wyjścia do bardziej zaawansowanych analiz statystycznych i pomagają zrozumieć istotę danych.

### 1. Tabele liczebności

W pierwszym etapie naszej analizy pogrupujemy nasze dane w postaci prostej tabeli częstości.Napotykamy tutaj jednak pewne problemy. Przykładowo zmienna 'income' jest zmienną ciągłą. Dokonamy więc diskretyzacji danych-przekształcimy zmienną ciągłą na zmienną dyskretną poprzez podział zakresu wartości na przedziały.

#### 1.Zmienna ciągła 'income'

```{r}
etykiety1<-c("0-25 000", "25 000-50 000", "50 000-75 000", "75 000-100 000", "100 000-125 000", "125 000-150 000")
limits1<-cut(rowery$income,seq(0,150000,by=25000),labels=etykiety1)
tabela2<-freq(limits1,type="html")
tabela2
tab1<-classIntervals(rowery$income,n=6,style="fixed",fixedBreaks=seq(0,150000,by=25000))
tab1
jenks.tests(tab1)
#wizualnie
hist(rowery$income, breaks="FD", col="green", probability = TRUE,
     main="INCOME")
```

Wskaźnik TAI jest dosyć wysoki, wiec możemy zaakceptować konstrukcję tabeli częstości.

#### 2. Zmienna dyskretna 'age'

```{r}
etykiety<-c("20-30 lat","30-40 lat","40-50 lat","50-60 lat","60-70 lat","70-80 lat")
limits<-cut(rowery$age,seq(20,80,by=10),labels=etykiety)
tabela1<-freq(limits,type="html")
tabela1
tab2<-classIntervals(rowery$age,n=6,style="fixed",fixedBreaks=seq(20,80,by=10))
tab2
jenks.tests(tab2)
# wizualnie
ggplot(rowery, aes(x = age)) +
  geom_histogram(binwidth = 2, fill = "blue", color = "red", alpha = 0.8) +
  labs(title = "Age Distribution", x = "Age", y = "Frequency")
```

Wskaźnik TAI jest dosyć wysoki, więc możemy zaakceptować konstrukcję tabeli częstości.

#### 3. Pozostałe tabele liczebności

```{r}
# EDUCATION
ggplot(rowery, aes(x = factor(education), fill = factor(education))) +
  geom_bar() +
  labs(title = "Education Distribution", x = "Education Level", y = "Count") +
  theme_minimal()

# REGION
ggplot(rowery, aes(x = factor(region), fill = factor(region))) +
  geom_bar() +
  labs(title = "Region Distribution", x = "Region", y = "Count") +
  theme_minimal()

# liczebnosc pozostaych zmiennych (zarowno liczbowa, jak i procentowa mozemy odczytac z tabelki)
dfSummary(rowery)
```

### 2. Podstawowe statystyki opisowe

Kolejnym etapem będzie przedstawienie podstawowych statystyk opisowych dla zmiennych ilościowych za pomocą zbiorczej tabelki.

```{r}
descr(rowery)
```

### 3. Korelacja

Poniżej przedstawiona została korelacja pomiędzy zmiennymi ilościowymi.

```{r}
cor((rowery[,c(4,5,9,12)]), method="pearson")
corrplot(cor(rowery[,c(4,5,9,12)]), method = "number", type = "upper", diag =FALSE)
corr_matrix<-cor(rowery[,c(4,5,9,12)])
corrplot(corr_matrix, method="color")
```

## IV ETAP- WNIOSKOWANIE STATYSTYCZNE

Testowanie hipotez opiera się na założeniu pewnych warunków w populacji, a następnie analizie próby w celu zweryfikowania, czy dane założenie jest prawdziwe. Statystyki testowe i wartości p-value dostarczają nam narzędzi do dokładnego zrozumienia, czy obserwowane różnice między grupami czy parametrami są statystycznie istotne. Jako poziom istotności przyjęto wartość 0.05.

### 1. Pytania badawcze

-   Czy wartość dochodu jest zależna od regionu?
-   Czy poziom wykształcenia na wpływ na poziom dochodu?
-   Czy w małżeństwach rodzi się wiecej dzieci?
-   Czy mężczyźni więcej zarabiają?
-   Czy osoby, które nie posiadają samochodu częściej kupują rowery?
-   Czy osoby, które posiadają domy częściej kupują rowery?

#### 1. pytanie badawcze

Dla zmiennych ,region' i 'income' zastosowano polecenie ggbetweenstats, adekwatne dla porównywania zmiennej jakościowej z ilościową. Na podstawie wartości p-value można stwierdzić, źe dochód istotnie różni się w zależności od regionu. 

```{r}
ggbetweenstats(rowery, region, income)+ggtitle("Średni dochód w zależności od regionu")+labs(x="Region", y="Dochód")
```

#### 2. pytanie badawcze

Dla zmiennych 'home_owner' i 'occupation' zastosowano funkcję ggbarstats, odpowiednią w przypadku porównywania ze sobą dwóch zmiennych jakościowych. Na podstawie wartości p-value można stwierdzić, że odsetek populacji posiadającej własny dom bądź mieszkanie istotnie różni się w zależności od rodzaju wykonywanej pracy. 

```{r}
ggbarstats(rowery, home_owner, occupation)+ggtitle("Posiadanie domu w zależności od rodzaju wykonywanej pracy")+labs(x="Zawód", y="Odsetek", fill="Posiadanie domu")
```

#### 3. pytanie badawcze

Na podstawie wartości p-value można stwierdzić, że średnia liczba posiadanych samochodów jest istotnie niższa wśród osób posiadających rower. 

```{r}
ggbetweenstats(rowery, purchased_bike, cars)+ggtitle("Ilość posiadanych samochodów w zależności od posiadania roweru")+labs(x="Posiadanie roweru", y="Ilość posiadanych samochodów")
```

#### 4. pytanie badawcze

Na podstawie otrzymanych wartości p-value można przyjąć, że średnie dochody istotnie różnią się w zależności od poziomu wykształcenia. 

```{r}
ggbetweenstats(rowery, education, income)+ggtitle("Średnie dochody w zależności od poziomu wykształcenia")+labs(x="Wykształcenie", y="Dochody")
```

#### 5. pytanie badawcze

Na podstawie wartości p-value dotyczącej całości obserwacji można przyjąć, że liczba posiadanych dzieci istotnie różni się w zależności od stanu cywilnego ankietowanej jednostki. Jednak przy analizie obserwacji dotyczącej wyłącznie osób posiadających dwójkę bądź trójkę dzieci, relacji pomiędzy liczbą dzieci, a stanem cywilnym nie można uznać za istotną z uwagi na wartość p-value przekraczającą przyjęty poziom istotności wynoszący 0.05.

```{r}
ggpiestats(rowery, marital_status, children)+ggtitle("Ilość posiadanych dzieci w zależności od stanu cywilnego")
```

### 2. Model logitowy

Dla zmiennej 'purchased_bike' postanowiono stworzyć model logitowy, który ma za zadanie sprawdzić, jaki wpływ mają poszczególne zmienne na fakt, że klient zdecydował się na kupno roweru. Zmienna 'purchased_bike' jest jakościowa i przyjmuje dwie kategorie 'Yes' oraz 'No'. Za pomocą model.matrix zmienna ta została przekodowana tak, aby miała postać binarną, czyli przyjmowała tylko dwie wartości 0 dla 'No' i 1 dla 'Yes'. Zmienne o największej wartości p-value były stopniowo usuwane z początkowego modelu zgodnie z metodą a posteriori, tak, aby otrzymać ostateczny model końcowy- model7.

```{r}
df <- data.frame(rowery$purchased_bike = c("No", "Yes"))
encoded_data <- model.matrix(~purchased_bike - 1, data = rowery)

model= glm(encoded_data ~ gender + marital_status + region + cars + income + age + occupation + education + home_owner + commute_distance, family = binomial, data=rowery)
summary(model)

#kolejno zgodnie z metoda a posteriori usuniete zostaly zmienne: commute_distance, gender, occupation, education, home_owner

#ostateczna postac modelu
model7= glm(encoded_data ~ marital_status  + cars + income + age, family = binomial, data=rowery)
summary(model7)

#Liczymy iloraz szans, aby otrzymac wartosci do interpretacji
OR=exp(model7$coefficients)
OR
```

INTERPRETACJE:
Jeżeli klient sklepu rowerowego jest singlem, to szanse na to, że kupi on rower maleją o około 40%.
Jeżeli klient posiada samochód, to szanse na to, że kupi rower wzrastają o około 67%.
Wraz ze wzrostem wieku o 1 rok, szanse na to, że klient kupi rower wsrastają o około 1,19%.

### 3. ANOVA ??
